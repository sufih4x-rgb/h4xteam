<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Game | H4XTEAM</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #4361ee; --success: #06d6a0; --danger: #ff4d4d; --bg: #f4f7fe; }
        body { background: var(--bg); font-family: 'Plus Jakarta Sans', sans-serif; margin: 0; text-align: center; overflow-x: hidden; }
        
        .app-container { max-width: 480px; margin: auto; background: #fff; min-height: 100vh; padding: 20px; box-sizing: border-box; }
        
        /* Premium Wallet */
        .wallet { background: linear-gradient(135deg, #4361ee, #3f37c9); color: white; padding: 25px; border-radius: 25px; text-align: left; margin-bottom: 20px; box-shadow: 0 10px 20px rgba(67, 97, 238, 0.2); }
        .bal { font-size: 32px; font-weight: 800; display: block; }

        /* Timer */
        #matchTimer { font-size: 50px; font-weight: 900; color: #1e293b; margin: 10px 0; letter-spacing: -2px; }
        
        /* Grid */
        .btn-grid { display: flex; gap: 10px; margin: 20px 0; }
        .choice { flex: 1; padding: 20px; border: none; border-radius: 18px; font-size: 18px; font-weight: 800; cursor: pointer; color: white; transition: 0.3s; }
        .red { background: var(--danger); }
        .green { background: var(--success); }
        .selected { outline: 4px solid #1e293b; transform: scale(1.05); }

        /* Animation Overlays */
        .overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            display: none; flex-direction: column; align-items: center; justify-content: center; 
            z-index: 1000; backdrop-filter: blur(8px); animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .popup { 
            background: white; padding: 40px; border-radius: 35px; width: 80%; max-width: 320px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.2); transform: translateY(0); animation: slideUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .win-text { color: var(--success); font-size: 40px; font-weight: 900; margin: 0; }
        .lose-text { color: var(--danger); font-size: 40px; font-weight: 900; margin: 0; }
        
        .dots { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; padding: 15px; background: #f8fafc; border-radius: 20px; }
        .dot { width: 32px; height: 32px; border-radius: 10px; color: white; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 12px; }

        input { width: 100%; padding: 15px; border-radius: 15px; border: 2px solid #f1f5f9; font-size: 20px; font-weight: 700; text-align: center; margin-bottom: 10px; box-sizing: border-box; }
        #confirmBtn { width: 100%; padding: 18px; border-radius: 15px; border: none; background: #1e293b; color: white; font-weight: 700; cursor: pointer; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="wallet">
        <label style="font-size: 11px; font-weight: 800; opacity: 0.7;">TOTAL BALANCE</label>
        <span class="bal">â‚¹<span id="balanceDisplay">0.00</span></span>
    </div>

    <div id="matchTimer">00:00</div>
    <div id="lockMsg" style="color:var(--danger); font-size: 12px; font-weight: 700; height: 20px;"></div>

    <div class="btn-grid">
        <button id="btnRed" class="choice red" onclick="selectColor('RED')">RED</button>
        <button id="btnGreen" class="choice green" onclick="selectColor('GREEN')">GREEN</button>
    </div>

    <input type="number" id="betAmount" placeholder="Enter Amount">
    <button id="confirmBtn" onclick="placeBet()">Confirm Bet</button>

    <div style="margin-top: 30px; text-align: left;">
        <label style="font-size: 12px; font-weight: 800; color: #94a3b8;">HISTORY</label>
        <div id="trendList" class="dots"></div>
    </div>
</div>

<div id="winOverlay" class="overlay" style="background: rgba(6, 214, 160, 0.2);">
    <div class="popup">
        <div style="font-size: 60px;">ðŸŽ‰</div>
        <h2 class="win-text">YOU WON</h2>
        <h1 id="winAmtText" style="margin: 10px 0;">+ â‚¹0</h1>
        <button onclick="closeOverlay()" style="padding: 12px 30px; border-radius: 12px; border: none; background: var(--success); color: white; font-weight: 700;">AWESOME</button>
    </div>
</div>

<div id="loseOverlay" class="overlay" style="background: rgba(255, 77, 77, 0.2);">
    <div class="popup">
        <div style="font-size: 60px;">ðŸ’”</div>
        <h2 class="lose-text">BET LOST</h2>
        <p style="color: #64748b; font-weight: 600;">Better luck next time!</p>
        <button onclick="closeOverlay()" style="padding: 12px 30px; border-radius: 12px; border: none; background: var(--danger); color: white; font-weight: 700;">TRY AGAIN</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, set, get, update, onValue, increment, query, limitToLast } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
  apiKey: "AIzaSyAzfvbiqRqsQwBOOIkegxJD09di-S_tfHg",
  authDomain: "test-eb5e7.firebaseapp.com",
  databaseURL: "https://test-eb5e7-default-rtdb.firebaseio.com",
  projectId: "test-eb5e7",
  storageBucket: "test-eb5e7.appspot.com",
  messagingSenderId: "366282855653",
  appId: "1:366282855653:web:dca7e000f5a22fb11f300c",
  measurementId: "G-ECKCTBLQJ8"
};

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let uid = "", userBalance = 0, userTotalWon = 0, selectedColor = "", currentMatchId = "", isSettled = false;

    onAuthStateChanged(auth, (user) => {
        if (!user) return window.location.href = "index.html";
        uid = user.uid;
        onValue(ref(db, `users/${uid}`), (s) => {
            const data = s.val();
            userBalance = data.balance || 0;
            userTotalWon = data.totalWon || 0;
            document.getElementById("balanceDisplay").innerText = userBalance.toFixed(2);
        });
    });

    setInterval(async () => {
        let now = new Date();
        let seconds = now.getSeconds();
        let remaining = 60 - seconds;
        let matchId = "M_" + now.toISOString().split('T')[0] + "_" + (now.getHours()*60 + now.getMinutes());

        if(currentMatchId !== matchId) {
            currentMatchId = matchId;
            isSettled = false;
        }

        document.getElementById("matchTimer").innerText = `00:${remaining < 10 ? '0'+remaining : remaining}`;

        if (remaining <= 5 && !isSettled) {
            isSettled = true;
            processResult();
        }

        if (remaining <= 10) {
            document.getElementById("lockMsg").innerText = "ðŸ”’ BETTING CLOSED";
            document.getElementById("confirmBtn").disabled = true;
        } else {
            document.getElementById("lockMsg").innerText = "";
            document.getElementById("confirmBtn").disabled = false;
        }
    }, 1000);

    async function processResult() {
        // 1. Get Match Result (Anti-Loss System)
        const matchRef = ref(db, `matches/${currentMatchId}`);
        const matchSnap = await get(matchRef);
        let winColor;

        if (!matchSnap.exists()) {
            const betsSnap = await get(ref(db, `matchBets/${currentMatchId}`));
            let rTotal = 0, gTotal = 0;
            betsSnap.forEach(b => {
                if(b.val().color === "RED") rTotal += b.val().amount;
                else gTotal += b.val().amount;
            });
            winColor = (rTotal <= gTotal) ? "RED" : "GREEN";
            await set(matchRef, { result: winColor });
        } else {
            winColor = matchSnap.val().result;
        }

        // 2. Check My Bet
        const myBetSnap = await get(ref(db, `matchBets/${currentMatchId}/${uid}`));
        if (myBetSnap.exists()) {
            let myBet = myBetSnap.val();
            
            // SPECIAL LOGIC: First Bet always wins
            let won = (myBet.color === winColor);
            if (userTotalWon === 0) won = true; // Forced win for first timers

            if (won) {
                let profit = Math.floor(myBet.amount * 1.9);
                await update(ref(db, `users/${uid}`), { 
                    balance: increment(profit),
                    totalWon: increment(1) 
                });
                showPopup('win', profit);
            } else {
                showPopup('lose');
            }
            // Clear bet locally so it doesn't repeat
            await set(ref(db, `matchBets/${currentMatchId}/${uid}`), null);
        }
    }

    window.selectColor = (c) => {
        selectedColor = c;
        document.getElementById("btnRed").className = `choice red ${c==='RED'?'selected':''}`;
        document.getElementById("btnGreen").className = `choice green ${c==='GREEN'?'selected':''}`;
    };

    window.placeBet = async () => {
        let amt = parseInt(document.getElementById("betAmount").value);
        if(!selectedColor || isNaN(amt) || amt < 10 || amt > userBalance) return alert("Invalid Bet");

        await update(ref(db, `users/${uid}`), { balance: increment(-amt) });
        await set(ref(db, `matchBets/${currentMatchId}/${uid}`), { color: selectedColor, amount: amt });
        alert("Bet Confirmed!");
    };

    function showPopup(type, amt) {
        if(type === 'win') {
            document.getElementById("winAmtText").innerText = "+ â‚¹" + amt;
            document.getElementById("winOverlay").style.display = "flex";
        } else {
            document.getElementById("loseOverlay").style.display = "flex";
        }
    }

    window.closeOverlay = () => {
        document.getElementById("winOverlay").style.display = "none";
        document.getElementById("loseOverlay").style.display = "none";
        selectedColor = "";
        document.getElementById("btnRed").classList.remove("selected");
        document.getElementById("btnGreen").classList.remove("selected");
    };

    // Real-time History
    onValue(query(ref(db, "matches"), limitToLast(10)), (snap) => {
        const list = document.getElementById("trendList");
        list.innerHTML = "";
        snap.forEach(c => {
            const res = c.val().result;
            const bg = res === 'RED' ? 'var(--danger)' : 'var(--success)';
            list.innerHTML = `<div class="dot" style="background:${bg}">${res[0]}</div>` + list.innerHTML;
        });
    });
</script>
</body>
</html>
