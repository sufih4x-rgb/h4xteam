<!DOCTYPE html>
<html>
<head>
    <title>H4X ADMIN - Financial Control</title>
    <style>
        body { background:#000; color:#0aff9d; font-family: monospace; padding:20px; }
        .card { border: 1px solid #0aff9d; padding:15px; margin-bottom:20px; background:#111; }
        table { width:100%; border-collapse:collapse; margin-top:10px; }
        th, td { border:1px solid #333; padding:10px; text-align:left; }
        button { cursor:pointer; padding:5px 10px; font-weight:bold; }
        .btn-approve { background:#0f0; color:#000; border:none; }
        .btn-reject { background:#f00; color:#fff; border:none; margin-left:5px; }
    </style>
</head>
<body>

<h1>⚡ ADMIN FINANCIAL CONTROL</h1>

<div class="card">
    <h3>Pending Withdrawals</h3>
    <table id="withdrawTable">
        <tr><th>User UID</th><th>Amount</th><th>UPI ID</th><th>Action</th></tr>
    </table>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, update, increment, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = { /* USE YOUR CONFIG HERE */ };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // LOAD WITHDRAWALS
    onValue(ref(db, "transactions/withdrawals/"), (snap) => {
        const table = document.getElementById("withdrawTable");
        table.innerHTML = `<tr><th>User UID</th><th>Amount</th><th>UPI ID</th><th>Action</th></tr>`;
        
        snap.forEach((userNode) => {
            const userId = userNode.key;
            userNode.forEach((wd) => {
                const data = wd.val();
                const wdId = wd.key;
                if(data.status === "pending") {
                    table.innerHTML += `
                    <tr>
                        <td>${userId}</td>
                        <td>₹${data.amount}</td>
                        <td>${data.upi}</td>
                        <td>
                            <button class="btn-approve" onclick="manageWD('${userId}','${wdId}',${data.amount},'approved')">Approve</button>
                            <button class="btn-reject" onclick="manageWD('${userId}','${wdId}',${data.amount},'rejected')">Reject (Refund)</button>
                        </td>
                    </tr>`;
                }
            });
        });
    });

    window.manageWD = async (uid, wdId, amt, status) => {
        if (status === 'rejected') {
            // REFUND the money back to user balance
            await update(ref(db, `users/${uid}`), { balance: increment(amt) });
            alert("Rejected and Refunded ₹" + amt);
        } else {
            alert("Withdrawal Approved!");
        }
        // Update the status so it disappears from the list
        await update(ref(db, `transactions/withdrawals/${uid}/${wdId}`), { status: status });
    };
</script>
</body>
</html>
