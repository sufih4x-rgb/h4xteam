<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>H4XTEAM - Red Green Global</title>
    <style>
        body { background:#000; color:#fff; font-family:Arial; text-align:center; padding:20px; }
        .btn { width:140px; padding:15px; margin:10px; border:none; border-radius:10px; font-size:18px; cursor:pointer; font-weight:bold; transition: 0.3s; }
        .red { background:#ff4444; box-shadow: 0 0 10px #ff4444; }
        .green { background:#00c853; box-shadow: 0 0 10px #00c853; }
        .disabled { background: #555 !important; cursor: not-allowed; box-shadow: none !important; }
        input { width:200px; padding:12px; background:#111; color:#0f0; border:2px solid #00ffcc; text-align:center; font-size:20px; border-radius:8px; }
        #matchTimer { font-size:32px; color:#00aaff; margin:20px 0; }
        #resultBox { margin-top:20px; padding:20px; border:2px solid #00ffcc; border-radius:12px; display:none; }
    </style>
</head>
<body>

    <h1>‚ö° GLOBAL RED-GREEN ‚ö°</h1>
    <h2>Balance: ‚Çπ<span id="balance">0</span></h2>

    <div id="gameControls">
        <button id="btnRed" class="btn red" onclick="selectColor('RED')">RED</button>
        <button id="btnGreen" class="btn green" onclick="selectColor('GREEN')">GREEN</button>
        <br>
        <input type="number" id="betAmount" placeholder="Amount (Min ‚Çπ10)">
        <br>
        <button id="placeBetBtn" class="btn" style="background:#00eeff; color:#000; width:300px;" onclick="placeBet()">CONFIRM BET</button>
    </div>

    <h2 id="matchTimer">Syncing...</h2>
    <p id="lockMsg" style="color:red; font-weight:bold;"></p>
    <div id="resultBox"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, get, update, onValue, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAzfvbiqRqsQwBOOIkegxJD09di-S_tfHg",
        authDomain: "test-eb5e7.firebaseapp.com",
        databaseURL: "https://test-eb5e7-default-rtdb.firebaseio.com",
        projectId: "test-eb5e7",
        storageBucket: "test-eb5e7.appspot.com",
        appId: "1:366282855653:web:dca7e000f5a22fb11f300c"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const uid = "USER_123"; // Replace with actual Auth UID from login

    let balance = 0;
    let selectedColor = "";
    let currentMatchId = "";
    let hasBetted = false;

    // Listen to Balance
    onValue(ref(db, `users/${uid}/balance`), (s) => {
        balance = s.val() || 0;
        document.getElementById("balance").innerText = balance;
    });

    // 24-HOUR GLOBAL TIMER SYSTEM
    setInterval(() => {
        let now = new Date();
        let totalSecs = (now.getHours() * 3600) + (now.getMinutes() * 60) + now.getSeconds();
        let matchWindow = Math.floor(totalSecs / 60); // 1-minute rounds
        let newMatchId = "M_" + now.toISOString().split('T')[0] + "_" + matchWindow;

        if (currentMatchId !== newMatchId) {
            currentMatchId = newMatchId;
            resetUIForNewRound();
        }

        let remaining = 60 - (totalSecs % 60);
        document.getElementById("matchTimer").innerText = `Time Left: ${remaining}s`;

        if (remaining <= 10) {
            document.getElementById("lockMsg").innerText = "BETTING CLOSED ‚è≥";
            document.getElementById("placeBetBtn").disabled = true;
        } else {
            document.getElementById("lockMsg").innerText = "";
            if(!hasBetted) document.getElementById("placeBetBtn").disabled = false;
        }

        if (remaining === 1) fetchResult();
    }, 1000);

    window.selectColor = (c) => {
        if(hasBetted) return;
        selectedColor = c;
        document.getElementById("btnRed").classList.toggle("disabled", c !== "RED");
        document.getElementById("btnGreen").classList.toggle("disabled", c !== "GREEN");
    };

    window.placeBet = async () => {
        let amt = Number(document.getElementById("betAmount").value);
        if (!selectedColor) return alert("Pick a color!");
        if (amt < 10 || amt > balance) return alert("Invalid amount!");
        if (hasBetted) return;

        hasBetted = true;
        document.getElementById("placeBetBtn").disabled = true;

        // Deduct balance & Save bet
        await update(ref(db, `users/${uid}`), { balance: increment(-amt) });
        await set(ref(db, `matchBets/${currentMatchId}/${uid}`), {
            color: selectedColor,
            amount: amt,
            status: "pending"
        });
        alert("Bet Placed on " + selectedColor);
    };

    async function fetchResult() {
        const s = await get(ref(db, `matches/${currentMatchId}`));
        if (s.exists()) {
            const winColor = s.val().result;
            processPayout(winColor);
        }
    }

    async function processPayout(winColor) {
        const myBetS = await get(ref(db, `matchBets/${currentMatchId}/${uid}`));
        if (!myBetS.exists()) return;
        
        const myBet = myBetS.val();
        const won = myBet.color === winColor;
        const box = document.getElementById("resultBox");
        box.style.display = "block";
        
        if (won) {
            let winAmt = myBet.amount * 2;
            await update(ref(db, `users/${uid}`), { balance: increment(winAmt) });
            box.innerHTML = `<h2 style='color:#0f0'>YOU WON! üéâ Winner: ${winColor}</h2>`;
        } else {
            box.innerHTML = `<h2 style='color:#f00'>YOU LOST! ‚ùå Winner: ${winColor}</h2>`;
        }
    }

    function resetUIForNewRound() {
        hasBetted = false;
        selectedColor = "";
        document.getElementById("btnRed").classList.remove("disabled");
        document.getElementById("btnGreen").classList.remove("disabled");
        document.getElementById("resultBox").style.display = "none";
        document.getElementById("betAmount").value = "";
    }
</script>
</body>
</html>
