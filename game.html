<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Red Green Game - H4XTEAM</title>

<style>
    body {
        background:#000;
        color:#fff;
        font-family:Arial;
        text-align:center;
        padding:20px;
    }
    h1 { color:#00ffcc; text-shadow:0 0 10px #00ffcc; }
    .btn {
        width:160px; padding:15px; margin:10px;
        border:none; border-radius:10px; font-size:20px;
        cursor:pointer; font-weight:bold;
        box-shadow:0 0 15px #00ffcc;
    }
    .red { background:#ff0000; }
    .green { background:#00ff00; color:#000; }
    input {
        width:60%; padding:12px; margin-top:15px;
        background:#000; color:#fff; font-size:20px;
        border-radius:8px; border:2px solid #00ffcc;
        text-align:center;
    }
    #matchTimer { margin-top:15px; font-size:24px; color:#00aaff; }
    #lockMsg { margin-top:10px; font-size:20px; color:#ff4444; }
    #resultBox {
        margin-top:25px; padding:20px;
        border:2px solid #00ffcc; border-radius:12px;
        display:none; font-size:22px;
        box-shadow:0 0 15px #00ffcc;
    }
</style>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js"></script>
</head>
<body>

<h1>RED ‚Äì GREEN GAME</h1>

<h2>Balance: ‚Çπ<span id="balance">0</span></h2>

<div>
    <button class="btn red" onclick="selectColor('RED')">RED</button>
    <button class="btn green" onclick="selectColor('GREEN')">GREEN</button>
</div>

<input type="number" id="betAmount" placeholder="Enter Bet Amount">

<h3 id="chosenColor"></h3>

<button class="btn" style="background:#00eeff;" onclick="placeBet()">PLACE BET</button>

<h2 id="matchTimer"></h2>
<h3 id="lockMsg"></h3>

<div id="resultBox"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getDatabase, ref, set, push, get, update, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAzfvbiqRqsQwBOOIkegxJD09di-S_tfHg",
  authDomain: "test-eb5e7.firebaseapp.com",
  databaseURL: "https://test-eb5e7-default-rtdb.firebaseio.com",
  projectId: "test-eb5e7",
  storageBucket: "test-eb5e7.appspot.com",
  messagingSenderId: "366282855653",
  appId: "1:366282855653:web:dca7e000f5a22fb11f300c",
  measurementId: "G-ECKCTBLQJ8"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let uid = "";
let balance = 0;
let selectedColor = "";

onAuthStateChanged(auth, async user => {
    if (!user) window.location = "index.html";
    uid = user.uid;

    let balSnap = await get(ref(db, "users/" + uid + "/balance"));
    if (balSnap.exists()) balance = balSnap.val();
    document.getElementById("balance").innerText = balance;
});

window.selectColor = function(color){
    selectedColor = color;
    document.getElementById("chosenColor").innerHTML =
        "Selected: <b style='color:"+ (color==="RED"?"#ff0000":"#00ff00") +"'>" + color + "</b>";
};


// ------------------------- MATCH SYSTEM ---------------------------

let MATCH_DURATION = 60;   // total 60s
let LOCK_TIME = 10;        // last 10 seconds locked
let timer = MATCH_DURATION;
let matchId = "";

function startMatchLoop(){

    setInterval(async ()=>{

        if (timer === MATCH_DURATION){
            matchId = "MATCH_" + Date.now();
            await set(ref(db, "matches/" + matchId), {
                start: Date.now(),
                result: "PENDING"
            });
        }

        // update UI timer
        document.getElementById("matchTimer").innerHTML = "Next Result in: " + timer + "s";

        // LOCK betting
        if (timer <= LOCK_TIME){
            document.getElementById("lockMsg").innerHTML = "Betting Locked! Wait for next match ‚è≥";
        } else {
            document.getElementById("lockMsg").innerHTML = "";
        }

        // TIME OVER -> SHOW RESULT
        if (timer === 0){
            await generateResult();
            timer = MATCH_DURATION;
        } else {
            timer--;
        }

    }, 1000);
}

startMatchLoop();

// -------------------------- PLACE BET ------------------------------
window.placeBet = async function(){

    let bet = Number(document.getElementById("betAmount").value);

    if (!selectedColor) return alert("Select RED or GREEN!");
    if (bet < 5 || bet > 1000) return alert("Bet must be between 5 and 1000");
    if (bet > balance) return alert("Insufficient balance");

    if (timer <= LOCK_TIME){
        return alert("MATCH LOCKED ‚ö†Ô∏è WAIT FOR NEXT MATCH");
    }

    let betId = push(ref(db, "matchBets/" + matchId + "/" + uid)).key;

    await set(ref(db, "matchBets/" + matchId + "/" + uid + "/" + betId), {
        user: uid,
        color: selectedColor,
        bet: bet,
        time: Date.now()
    });

    alert("Bet Placed Successfully!");
};

// --------------------------- RESULT GENERATION ----------------------

async function generateResult(){
    let winner = Math.random() > 0.5 ? "RED" : "GREEN";

    await update(ref(db, "matches/" + matchId), { result: winner });

    // get all bets of this match
    let betsSnap = await get(ref(db, "matchBets/" + matchId));
    if (!betsSnap.exists()) return;

    let bets = betsSnap.val();

    for (let userKey in bets){
        for (let betKey in bets[userKey]){

            let b = bets[userKey][betKey];
            let won = (b.color === winner);
            let profit = won ? b.bet * 2 : -b.bet;

            let userBalSnap = await get(ref(db, "users/" + userKey + "/balance"));
            let userBal = userBalSnap.exists() ? userBalSnap.val() : 0;
            let newBalance = userBal + profit;

            await update(ref(db, "users/" + userKey), { balance: newBalance });

            if (uid === userKey){  // show result ONLY for current user
                document.getElementById("balance").innerText = newBalance;

                let box = document.getElementById("resultBox");
                box.style.display = "block";

                if (won){
                    box.innerHTML = `
                        <span style='color:#00ff99;font-size:26px;'>YOU WON üéâ</span><br>
                        Winner: ${winner}<br>
                        Profit: ‚Çπ${profit}<br>
                        New Balance: ‚Çπ${newBalance}
                    `;
                } else {
                    box.innerHTML = `
                        <span style='color:#ff4444;font-size:26px;'>YOU LOST ‚ùå</span><br>
                        Winner: ${winner}<br>
                        Lost: ‚Çπ${b.bet}<br>
                        New Balance: ‚Çπ${newBalance}
                    `;
                }
            }
        }
    }
}
</script>

</body>
</html>
