<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantum Elite | 2025 Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #4361ee; --success: #00d084; --danger: #ff4757; 
            --big-lite: #ffeb3b; --small-lite: #03a9f4;
            --bg: #ffffff; --card: #f8faff;
        }
        
        body { background: var(--bg); font-family: 'Plus Jakarta Sans', sans-serif; color: #1e293b; margin: 0; }
        .app-container { max-width: 480px; margin: auto; min-height: 100vh; padding: 20px; }

        /* Wallet */
        .wallet-card { 
            background: #111827; color: #fff; padding: 25px; border-radius: 28px; 
            margin-bottom: 25px; box-shadow: 0 15px 30px rgba(0,0,0,0.1);
            background-image: linear-gradient(135deg, #4361ee 0%, #1e293b 100%);
        }
        .wallet-card b { display: block; font-size: 32px; letter-spacing: -1px; margin-top: 5px; }

        /* Timer & Period */
        .info-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .period-info { font-weight: 800; font-size: 13px; color: #94a3b8; }
        #timer { font-size: 55px; font-weight: 900; letter-spacing: -3px; color: #111827; }

        /* Game Modes */
        .mode-selector { display: flex; gap: 10px; background: #f1f5f9; padding: 6px; border-radius: 16px; margin-bottom: 25px; }
        .m-btn { flex: 1; padding: 12px; border: none; border-radius: 12px; background: transparent; font-weight: 700; cursor: pointer; color: #64748b; }
        .m-btn.active { background: #fff; color: var(--primary); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }

        /* Betting Engine */
        .engine { background: var(--card); border-radius: 32px; padding: 20px; border: 1px solid #f1f5f9; }
        .row { display: flex; gap: 12px; margin-bottom: 12px; }
        .opt { flex: 1; padding: 18px; border: none; border-radius: 18px; font-weight: 800; cursor: pointer; transition: 0.2s; }
        .green { background: var(--success); color: #fff; }
        .red { background: var(--danger); color: #fff; }
        .big { background: #fef9c3; color: #854d0e; }
        .small { background: #e0f2fe; color: #075985; }
        .opt.selected { transform: scale(0.92); outline: 3px solid #111827; }

        .n-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin: 15px 0; }
        .n-btn { aspect-ratio: 1; border: 1px solid #e2e8f0; background: #fff; border-radius: 12px; font-weight: 800; cursor: pointer; }
        .n-btn.selected { background: #111827; color: #fff; }

        input { width: 100%; padding: 18px; border-radius: 18px; border: 2px solid #f1f5f9; font-size: 20px; font-weight: 800; text-align: center; margin-bottom: 15px; box-sizing: border-box; }
        #betBtn { width: 100%; padding: 20px; border: none; border-radius: 18px; background: #111827; color: #fff; font-weight: 800; font-size: 16px; cursor: pointer; }

        /* Chart */
        .chart-section { margin-top: 30px; }
        .h-item { display: flex; justify-content: space-between; align-items: center; padding: 14px; border-bottom: 1px solid #f1f5f9; }
        .res-box { display: flex; align-items: center; gap: 10px; }
        .dot { width: 34px; height: 34px; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: #fff; font-weight: 800; position: relative; }
        .badge { position: absolute; top: -6px; right: -6px; width: 18px; height: 18px; border-radius: 50%; font-size: 9px; display: flex; align-items: center; justify-content: center; border: 2px solid #fff; font-weight: 900; }

        /* Overlay */
        .overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.98); z-index: 2000; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .pop { animation: zoom 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes zoom { from { transform: scale(0); } to { transform: scale(1); } }
        .win-tag { background: #111827; color: #fff; padding: 4px 12px; border-radius: 10px; font-size: 10px; margin: 2px; display: inline-block; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="wallet-card">
        <small>AVAILABLE BALANCE</small>
        <b>₹<span id="balDisplay">0.00</span></b>
    </div>

    <div class="mode-selector">
        <button class="m-btn active" onclick="switchMode(30, this)">30S</button>
        <button class="m-btn" onclick="switchMode(60, this)">1M</button>
        <button class="m-btn" onclick="switchMode(300, this)">5M</button>
    </div>

    <div class="info-bar">
        <div class="period-info">PERIOD<br><span id="periodId" style="color:#111827">---</span></div>
        <div id="timer">00:00</div>
    </div>

    <div class="engine">
        <div class="row">
            <button class="opt green" onclick="setPick('color','GREEN',this)">GREEN</button>
            <button class="opt red" onclick="setPick('color','RED',this)">RED</button>
        </div>
        <div class="row">
            <button class="opt big" onclick="setPick('size','BIG',this)">BIG</button>
            <button class="opt small" onclick="setPick('size','SMALL',this)">SMALL</button>
        </div>
        <div class="n-grid" id="numberGrid"></div>
        <input type="number" id="amount" placeholder="Enter Amount">
        <button id="betBtn" onclick="confirmBet()">PLACE PREDICTION</button>
    </div>

    <div class="chart-section">
        <div id="chartContainer"></div>
    </div>
</div>

<div id="resOverlay" class="overlay">
    <div class="pop">
        <div id="tags"></div>
        <h1 id="statusText" style="font-size: 40px; margin: 10px 0;">WIN</h1>
        <h2 id="winValue" style="font-size: 32px; color: var(--success);">+₹0.00</h2>
        <button onclick="closeResult()" style="margin-top:20px; padding:15px 40px; border-radius:15px; border:none; background:#111827; color:#fff; font-weight:800;">NEXT ROUND</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, set, get, update, onValue, increment, query, limitToLast } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAzfvbiqRqsQwBOOIkegxJD09di-S_tfHg",
        authDomain: "test-eb5e7.firebaseapp.com",
        databaseURL: "https://test-eb5e7-default-rtdb.firebaseio.com",
        projectId: "test-eb5e7",
        appId: "1:366282855653:web:dca7e000f5a22fb11f300c"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let uid = "", balance = 0, mode = 30, currentMatch = "", selections = { color: null, size: null, num: null };

    // Init Numbers
    const grid = document.getElementById("numberGrid");
    for(let i=0; i<=9; i++) grid.innerHTML += `<button class="n-btn" onclick="setPick('num',${i},this)">${i}</button>`;

    onAuthStateChanged(auth, u => {
        if(!u) return; uid = u.uid;
        onValue(ref(db, `users/${uid}`), s => {
            balance = s.val()?.balance || 0;
            document.getElementById("balDisplay").innerText = balance.toFixed(2);
        });
    });

    window.switchMode = (m, b) => {
        mode = m;
        document.querySelectorAll('.m-btn').forEach(btn => btn.classList.remove('active'));
        b.classList.add('active');
        loadHistory(); // Switch Chart
    };

    window.setPick = (t, v, b) => {
        selections[t] = (selections[t] === v) ? null : v;
        b.parentElement.querySelectorAll(t==='num'?'.n-btn':'.opt').forEach(btn => btn.classList.remove('selected'));
        if(selections[t] !== null) b.classList.add('selected');
    };

    // Global Sync Timer
    setInterval(() => {
        const d = new Date();
        const now = Math.floor(d.getTime() / 1000);
        const rem = mode - (now % mode);
        currentMatch = `${d.getHours()}${d.getMinutes()}_${Math.floor(d.getSeconds()/mode)}`;
        
        document.getElementById("periodId").innerText = `20251226_${mode}_${currentMatch}`;
        document.getElementById("timer").innerText = `00:${rem < 10 ? '0'+rem : rem}`;

        if(rem === 1) calculateResult();
    }, 1000);

    window.confirmBet = async () => {
        const amt = parseInt(document.getElementById("amount").value);
        if(isNaN(amt) || amt < 10 || amt > balance) return alert("Check Amount/Balance");
        if(!selections.color && !selections.size && !selections.num) return alert("Pick something!");

        await update(ref(db, `users/${uid}`), { balance: increment(-amt) });
        await set(ref(db, `bets_${mode}/${currentMatch}/${uid}/${Date.now()}`), { ...selections, amount: amt });
        alert("Bet Locked!");
    };

    async function calculateResult() {
        const resPath = ref(db, `results_${mode}/${currentMatch}`);
        const snap = await get(resPath);
        let res;

        if(!snap.exists()) {
            // ANTI-3-RED & HOUSE EDGE
            const history = await get(query(ref(db, `results_${mode}`), limitToLast(3)));
            let rCount = 0;
            history.forEach(h => { if(h.val().color === 'RED') rCount++; });

            const allBets = await get(ref(db, `bets_${mode}/${currentMatch}`));
            let vol = { RED:0, GREEN:0, BIG:0, SMALL:0 };
            allBets.forEach(u => u.forEach(b => {
                const d = b.val();
                if(d.color) vol[d.color] += d.amount;
                if(d.size) vol[d.size] += d.amount;
            }));

            let fColor = (rCount >= 3) ? "GREEN" : (vol.RED <= vol.GREEN ? "RED" : "GREEN");
            let fSize = (vol.BIG <= vol.SMALL) ? "BIG" : "SMALL";
            let fNum = fSize === "BIG" ? Math.floor(Math.random() * 5) + 5 : Math.floor(Math.random() * 5);

            res = { color: fColor, size: fSize, num: fNum };
            await set(resPath, res);
        } else { res = snap.val(); }

        // Payout Calculation
        const my = await get(ref(db, `bets_${mode}/${currentMatch}/${uid}`));
        if(my.exists()) {
            let win = 0, tags = [];
            let lucky = balance > 200 ? 0.2 : 1.0;

            my.forEach(b => {
                const d = b.val();
                if(d.color === res.color && Math.random() < lucky) { win += d.amount * 1.92; tags.push("COLOR"); }
                if(d.size === res.size && Math.random() < lucky) { win += d.amount * 1.92; tags.push("SIZE"); }
                if(d.num === res.num && Math.random() < lucky) { win += d.amount * 4.44; tags.push("NUMBER"); }
            });

            const over = document.getElementById("resOverlay");
            const tagBox = document.getElementById("tags");
            tagBox.innerHTML = "";
            
            if(win > 0) {
                tags.forEach(t => tagBox.innerHTML += `<span class="win-tag">${t} WIN</span>`);
                document.getElementById("statusText").innerText = tags.length > 1 ? "COMBO WIN!" : "WINNER";
                document.getElementById("statusText").style.color = "var(--success)";
                document.getElementById("winValue").innerText = "+₹" + win.toFixed(2);
                await update(ref(db, `users/${uid}`), { balance: increment(win) });
            } else {
                document.getElementById("statusText").innerText = "LOSE";
                document.getElementById("statusText").style.color = "var(--danger)";
                document.getElementById("winValue").innerText = "Zero Return";
            }
            over.style.display = "flex";
        }
    }

    function loadHistory() {
        onValue(query(ref(db, `results_${mode}`), limitToLast(12)), s => {
            const container = document.getElementById("chartContainer");
            container.innerHTML = `<h3 style="font-size:12px; color:#94a3b8">HISTORY (${mode}S)</h3>`;
            s.forEach(m => {
                const d = m.val();
                const isB = d.size === 'BIG';
                container.innerHTML += `
                    <div class="h-item">
                        <span style="font-size:11px; font-weight:700">#${m.key.split('_')[1]}</span>
                        <div class="res-box">
                            <div class="dot" style="background:${d.color==='RED'?'var(--danger)':'var(--success)'}">
                                ${d.num}
                                <div class="badge" style="background:${isB?'var(--big-lite)':'var(--small-lite)'}; color:#000">
                                    ${isB?'B':'S'}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
        });
    }

    window.closeResult = () => {
        document.getElementById("resOverlay").style.display = "none";
        document.querySelectorAll('.opt, .n-btn').forEach(b => b.classList.remove('selected'));
        selections = { color: null, size: null, num: null };
    };

    loadHistory(); // Initial Load
</script>
</body>
</html>
