<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Control | H4XTEAM</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4361ee;
            --success: #06d6a0;
            --danger: #ff4d4d;
            --warning: #fb8500;
            --freeze: #3f37c9;
            --bg: #f4f7fe;
            --white: #ffffff;
            --text-dark: #1e293b;
            --text-light: #64748b;
        }

        body {
            background-color: var(--bg);
            color: var(--text-dark);
            font-family: 'Plus Jakarta Sans', sans-serif;
            margin: 0;
            padding: 30px;
        }

        .btn-loading {
            position: relative;
            color: transparent !important;
            pointer-events: none;
        }
        .btn-loading::after {
            content: "";
            position: absolute;
            width: 16px; height: 16px;
            top: 50%; left: 50%;
            margin: -8px 0 0 -8px;
            border: 2px solid rgba(0,0,0,0.1);
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        h1 { font-weight: 800; letter-spacing: -1px; margin-bottom: 30px; }
        h2 { font-size: 14px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-light); margin-bottom: 20px; }

        .section {
            background: var(--white);
            padding: 25px;
            border-radius: 24px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.04);
            border: 1px solid rgba(0,0,0,0.02);
            margin-bottom: 30px;
        }

        .grid-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; padding: 15px; background: #f8fafc; font-size: 11px; color: var(--text-light); border-bottom: 2px solid #f1f5f9; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; font-size: 13px; font-weight: 600; }

        input { padding: 10px; border-radius: 10px; border: 1px solid #e2e8f0; font-family: inherit; box-sizing: border-box; }
        
        button {
            padding: 10px 18px;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            border: none;
            transition: 0.2s;
            font-size: 11px;
        }

        .btn-blue { background: var(--primary); color: white; }
        .btn-green { background: #e6fcf5; color: #087f5b; }
        .btn-red { background: #fff5f5; color: #c53030; }
        .btn-ban { background: #1e293b; color: white; }
        .btn-freeze { background: #edf2ff; color: var(--freeze); border: 1px solid #dbe4ff; }

        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--primary); display: flex; justify-content: center; align-items: center; z-index: 10000;
        }
        .login-card { background: white; padding: 40px; border-radius: 30px; text-align: center; width: 320px; }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-card">
        <div style="font-size: 40px; margin-bottom: 15px;">üóùÔ∏è</div>
        <h2>Admin Access</h2>
        <input type="password" id="adminPass" placeholder="Enter System Key" style="text-align: center; margin-bottom: 20px; width: 100%;">
        <button class="btn-blue" style="width: 100%;" onclick="checkAuth()">Unlock Dashboard</button>
    </div>
</div>

<h1>System Control Panel</h1>

<div class="grid-layout">
    <div class="section">
        <h2>üí≥ Gateway & Games Config</h2>
        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <input type="text" id="upiInput" placeholder="Active UPI ID" style="flex: 1;">
            <button class="btn-blue" onclick="saveConfig('upi', 'upiInput')">Update UPI</button>
        </div>
        <div style="display: flex; gap: 10px;">
            <input type="text" id="qrInput" placeholder="QR Image URL" style="flex: 1;">
            <button class="btn-blue" onclick="saveConfig('qr', 'qrInput')">Update QR</button>
        </div>
    </div>

    <div class="section">
        <h2>üìä Global Float</h2>
        <div style="font-size: 28px; font-weight: 800; color: var(--primary);">‚Çπ<span id="totalStats">0</span></div>
        <div style="font-size: 11px; color: var(--text-light); margin-top: 5px;">Total User Balances Combined</div>
    </div>
</div>

<div class="section">
    <h2>üë• User Management (Freeze/Unfreeze & Balance)</h2>
    <div style="overflow-x: auto;">
        <table>
            <thead>
                <tr>
                    <th>User Detail</th>
                    <th>Balance</th>
                    <th>Set Amt</th>
                    <th>Status</th>
                    <th>Freeze Action & Reason</th>
                    <th>Access</th>
                </tr>
            </thead>
            <tbody id="userList"></tbody>
        </table>
    </div>
</div>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
    <div class="section">
        <h2>üì• Deposit Requests</h2>
        <table id="depositTable">
            <tbody id="depositList"></tbody>
        </table>
    </div>
    <div class="section">
        <h2>üì§ Withdrawal Requests</h2>
        <table id="withdrawTable">
            <tbody id="withdrawList"></tbody>
        </table>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, update, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAzfvbiqRqsQwBOOIkegxJD09di-S_tfHg",
        authDomain: "test-eb5e7.firebaseapp.com",
        databaseURL: "https://test-eb5e7-default-rtdb.firebaseio.com",
        projectId: "test-eb5e7",
        appId: "1:366282855653:web:dca7e000f5a22fb11f300c"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    window.checkAuth = function() {
        if(document.getElementById("adminPass").value === "admin123") {
            document.getElementById("loginOverlay").style.display = "none";
            loadData();
        } else { alert("Access Denied"); }
    };

    function loadData() {
        // Load Settings
        onValue(ref(db, "settings/payment"), snap => {
            const d = snap.val();
            if(d) {
                document.getElementById("upiInput").value = d.upi || "";
                document.getElementById("qrInput").value = d.qr || "";
            }
        });

        // Load Users
        onValue(ref(db, "users/"), snap => {
            let html = ""; let total = 0;
            snap.forEach(child => {
                const u = child.val();
                total += (u.balance || 0);
                const isBanned = u.status === "banned";
                const isFrozen = u.status === "frozen";

                html += `<tr>
                    <td>
                        <div style="font-weight:800">${u.email ? u.email.split('@')[0] : 'User'}</div>
                        <div style="font-size:9px; color:gray;">ID: ${child.key.substring(0,8)}</div>
                    </td>
                    <td>‚Çπ${(u.balance || 0).toLocaleString()}</td>
                    <td>
                        <input id="adj_${child.key}" type="number" style="width:60px; font-size:11px;" placeholder="0">
                        <button class="btn-blue" style="padding:5px 8px" onclick="adjustBalance(this, '${child.key}')">OK</button>
                    </td>
                    <td>
                        <span style="color:${isBanned ? 'red' : (isFrozen ? 'blue' : 'green')}">
                            ${isBanned ? '‚óè BANNED' : (isFrozen ? '‚ùÑÔ∏è FROZEN' : '‚óè ACTIVE')}
                        </span>
                    </td>
                    <td>
                        <input id="res_${child.key}" type="text" placeholder="Reason..." value="${u.freezeReason || ''}" style="width:100px; font-size:10px;">
                        <button class="${isFrozen ? 'btn-green' : 'btn-freeze'}" onclick="toggleFreeze(this, '${child.key}', ${isFrozen})">
                            ${isFrozen ? 'UNFREEZE' : 'FREEZE'}
                        </button>
                    </td>
                    <td>
                        <button class="${isBanned ? 'btn-green' : 'btn-ban'}" onclick="toggleStatus(this, '${child.key}', '${isBanned ? 'active' : 'banned'}')">
                            ${isBanned ? 'UNBAN' : 'BAN'}
                        </button>
                    </td>
                </tr>`;
            });
            document.getElementById("userList").innerHTML = html;
            document.getElementById("totalStats").innerText = total.toLocaleString();
        });

        // Load Deposits
        onValue(ref(db, "transactions/deposits/"), snap => {
            let html = "<tr><th>UTR</th><th>Amt</th><th>Opt</th></tr>";
            snap.forEach(uNode => {
                uNode.forEach(tx => {
                    if(tx.val().status === "pending") {
                        html += `<tr><td>${tx.key}</td><td>‚Çπ${tx.val().amount}</td><td>
                            <button class="btn-green" onclick="handleDeposit(this, '${uNode.key}', '${tx.key}', ${tx.val().amount}, 'approved')">‚úî</button>
                            <button class="btn-red" onclick="handleDeposit(this, '${uNode.key}', '${tx.key}', 0, 'rejected')">‚úñ</button>
                        </td></tr>`;
                    }
                });
            });
            document.getElementById("depositList").innerHTML = html;
        });

        // Load Withdrawals
        onValue(ref(db, "transactions/withdrawals/"), snap => {
            let html = "<tr><th>User</th><th>Amt</th><th>Opt</th></tr>";
            snap.forEach(uNode => {
                uNode.forEach(wd => {
                    if(wd.val().status === "pending") {
                        html += `<tr><td>${uNode.key.substring(0,5)}</td><td>‚Çπ${wd.val().amount}</td><td>
                            <button class="btn-green" onclick="handleWithdraw(this, '${uNode.key}', '${wd.key}', 'approved')">PAID</button>
                            <button class="btn-red" onclick="handleWithdraw(this, '${uNode.key}', '${wd.key}', 'rejected', ${wd.val().amount})">‚úñ</button>
                        </td></tr>`;
                    }
                });
            });
            document.getElementById("withdrawList").innerHTML = html;
        });
    }

    // --- LOGIC FUNCTIONS ---

    window.toggleFreeze = async function(btn, uid, isFrozen) {
        const reason = document.getElementById(`res_${uid}`).value;
        if(!isFrozen && !reason) return alert("Enter reason first!");
        
        btn.classList.add('btn-loading');
        await update(ref(db, `users/${uid}`), {
            status: isFrozen ? "active" : "frozen",
            freezeReason: isFrozen ? "" : reason
        });
        btn.classList.remove('btn-loading');
    };

    window.adjustBalance = async function(btn, uid) {
        const amt = Number(document.getElementById(`adj_${uid}`).value);
        btn.classList.add('btn-loading');
        await update(ref(db, `users/${uid}`), { balance: amt });
        btn.classList.remove('btn-loading');
    };

    window.toggleStatus = async function(btn, uid, newStat) {
        btn.classList.add('btn-loading');
        await update(ref(db, `users/${uid}`), { status: newStat });
        btn.classList.remove('btn-loading');
    };

    window.saveConfig = async function(type, inputId) {
        const val = document.getElementById(inputId).value;
        await update(ref(db, "settings/payment"), { [type]: val });
        alert("Updated!");
    };

    window.handleDeposit = async function(btn, uid, txid, amt, status) {
        btn.classList.add('btn-loading');
        if(status === 'approved') await update(ref(db, `users/${uid}`), { balance: increment(amt) });
        await update(ref(db, `transactions/deposits/${uid}/${txid}`), { status: status });
        btn.classList.remove('btn-loading');
    };

    window.handleWithdraw = async function(btn, uid, wid, status, refund = 0) {
        btn.classList.add('btn-loading');
        if(status === 'rejected') await update(ref(db, `users/${uid}`), { balance: increment(refund) });
        await update(ref(db, `transactions/withdrawals/${uid}/${wid}`), { status: status });
        btn.classList.remove('btn-loading');
    };
</script>
</body>
</html>
