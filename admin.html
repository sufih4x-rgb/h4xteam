<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Financial Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .action-btn { transition: all 0.2s; }
        .action-btn:hover { transform: scale(1.05); }
    </style>
</head>
<body class="bg-slate-50 font-sans">

    <div class="flex flex-col md:flex-row min-h-screen">
        <div class="bg-slate-900 text-white w-full md:w-64 flex-shrink-0">
            <div class="p-6 text-2xl font-bold border-b border-slate-700">Admin Panel</div>
            <nav class="mt-4">
                <a href="#" onclick="showTab('users-tab')" class="block py-3 px-6 hover:bg-slate-800 border-l-4 border-transparent hover:border-blue-500"><i class="fas fa-users mr-3"></i> Users</a>
                <a href="#" onclick="showTab('withdraw-tab')" class="block py-3 px-6 hover:bg-slate-800 border-l-4 border-transparent hover:border-blue-500"><i class="fas fa-money-bill-wave mr-3"></i> Withdraw Requests</a>
                <a href="#" onclick="showTab('deposit-tab')" class="block py-3 px-6 hover:bg-slate-800 border-l-4 border-transparent hover:border-blue-500"><i class="fas fa-plus-circle mr-3"></i> Deposit Requests</a>
                <a href="#" onclick="showTab('recharge-tab')" class="block py-3 px-6 hover:bg-slate-800 border-l-4 border-transparent hover:border-blue-500"><i class="fas fa-mobile-alt mr-3"></i> SIM Recharge</a>
            </nav>
        </div>

        <div class="flex-1 p-4 md:p-8">
            
            <div id="withdraw-tab" class="tab-content active">
                <h2 class="text-3xl font-bold text-slate-800 mb-6">Withdrawal Requests</h2>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-slate-200">
                    <table class="w-full text-left">
                        <thead class="bg-slate-100 border-b border-slate-200">
                            <tr>
                                <th class="px-6 py-4 text-sm font-semibold text-slate-600">User UID</th>
                                <th class="px-6 py-4 text-sm font-semibold text-slate-600">Amount</th>
                                <th class="px-6 py-4 text-sm font-semibold text-slate-600 text-blue-600">UPI ID / Method</th>
                                <th class="px-6 py-4 text-sm font-semibold text-slate-600">Action</th>
                            </tr>
                        </thead>
                        <tbody id="withdrawList" class="divide-y divide-slate-100">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="users-tab" class="tab-content">
                <h2 class="text-3xl font-bold mb-6">Search User</h2>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <div class="flex gap-3">
                        <input id="searchUid" type="text" placeholder="Enter User UID" class="flex-1 border p-3 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                        <button onclick="searchUser()" class="bg-blue-600 text-white px-8 py-3 rounded-lg font-medium hover:bg-blue-700">Search</button>
                    </div>
                    <div id="userDetails" class="hidden mt-8 p-6 bg-slate-50 rounded-lg border border-slate-200">
                        <div class="grid grid-cols-2 gap-4">
                            <p class="text-slate-600">Name: <span id="uName" class="font-bold text-slate-900">-</span></p>
                            <p class="text-slate-600">Balance: <span class="font-bold text-green-600">$<span id="uBalance">0</span></span></p>
                            <p class="text-slate-600">Status: <span id="uStatus" class="px-2 py-1 rounded text-xs uppercase font-bold">-</span></p>
                        </div>
                        <div class="mt-6 flex items-center gap-4">
                            <input id="addAmount" type="number" placeholder="Amt" class="w-32 border p-2 rounded-lg">
                            <button onclick="updateBalance()" class="bg-green-600 text-white px-4 py-2 rounded-lg">Add Balance</button>
                            <button id="banBtn" onclick="toggleBan()" class="bg-red-600 text-white px-4 py-2 rounded-lg">Ban User</button>
                        </div>
                    </div>
                </div>
            </div>
            
            </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getDatabase, ref, onValue, update, get, remove } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAzfvbiqRqsQwBOOIkegxJD09di-S_tfHg",
            authDomain: "test-eb5e7.firebaseapp.com",
            databaseURL: "https://test-eb5e7-default-rtdb.firebaseio.com",
            projectId: "test-eb5e7",
            storageBucket: "test-eb5e7.appspot.com",
            messagingSenderId: "366282855653",
            appId: "1:366282855653:web:dca7e000f5a22fb11f300c",
            measurementId: "G-ECKCTBLQJ8"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Navigation
        window.showTab = (id) => {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        };

        // LOAD WITHDRAWALS (With UPI ID support)
        const loadWithdrawals = () => {
            const withdrawRef = ref(db, 'withdraws');
            onValue(withdrawRef, (snapshot) => {
                const container = document.getElementById('withdrawList');
                container.innerHTML = "";
                snapshot.forEach((childSnapshot) => {
                    const data = childSnapshot.val();
                    const id = childSnapshot.key;
                    
                    // Note: 'data.upi' is where we expect the user's UPI ID
                    container.innerHTML += `
                        <tr class="hover:bg-slate-50 transition">
                            <td class="px-6 py-4 font-mono text-xs text-slate-500">${data.uid}</td>
                            <td class="px-6 py-4 font-bold text-slate-800">$${data.amount}</td>
                            <td class="px-6 py-4">
                                <span class="bg-blue-50 text-blue-700 px-3 py-1 rounded-full text-sm font-medium border border-blue-100">
                                    ${data.upi || data.method || 'No UPI Provided'}
                                </span>
                            </td>
                            <td class="px-6 py-4 space-x-2">
                                <button onclick="processReq('withdraws', '${id}', 'Approved')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded shadow-sm text-sm action-btn">Approve</button>
                                <button onclick="processReq('withdraws', '${id}', 'Rejected')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded shadow-sm text-sm action-btn">Reject</button>
                            </td>
                        </tr>
                    `;
                });
            });
        };

        window.processReq = async (path, key, status) => {
            if(confirm(`Are you sure you want to mark this as ${status}?`)) {
                // Here you would typically move the record to a 'history' node
                // For now, we delete it from the active request list
                await remove(ref(db, `${path}/${key}`));
                alert(`Request ${status}`);
            }
        };

        // User Search Logic
        window.searchUser = async () => {
            const uid = document.getElementById('searchUid').value;
            if(!uid) return alert("Enter UID");
            
            const userRef = ref(db, `users/${uid}`);
            const snap = await get(userRef);
            if(snap.exists()) {
                const u = snap.val();
                document.getElementById('userDetails').classList.remove('hidden');
                document.getElementById('uName').innerText = u.name || "N/A";
                document.getElementById('uBalance').innerText = u.balance || 0;
                const statusEl = document.getElementById('uStatus');
                statusEl.innerText = u.status || "Active";
                statusEl.className = u.status === 'Banned' ? 'bg-red-100 text-red-700 px-2 py-1 rounded text-xs uppercase font-bold' : 'bg-green-100 text-green-700 px-2 py-1 rounded text-xs uppercase font-bold';
            } else {
                alert("User not found");
            }
        };

        // Initialize
        loadWithdrawals();

    </script>
</body>
</html>
