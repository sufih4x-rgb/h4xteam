<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H4X Master Admin v11 | Ultimate Control</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #6366f1; --success: #10b981; --danger: #ef4444; --dark: #0f172a; --warning: #f59e0b; }
        body { margin: 0; font-family: 'Plus Jakarta Sans', sans-serif; background: #f8fafc; display: flex; color: #1e293b; }
        
        .sidebar { width: 260px; height: 100vh; background: var(--dark); color: white; position: fixed; }
        .nav-item { padding: 14px 25px; cursor: pointer; transition: 0.3s; font-weight: 600; color: #94a3b8; display: flex; align-items: center; gap: 12px; font-size: 13px; }
        .nav-item.active { background: var(--primary); color: white; }
        
        .main { margin-left: 260px; width: calc(100% - 260px); padding: 30px; box-sizing: border-box; }
        .card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 25px; border: 1px solid #e2e8f0; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; padding: 12px; background: #f1f5f9; font-size: 11px; color: #64748b; text-transform: uppercase; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 13px; }
        
        .btn-action { padding: 6px 12px; border-radius: 6px; font-weight: 700; cursor: pointer; border: none; font-size: 11px; }
        .bg-success { background: var(--success); color: white; }
        .bg-danger { background: var(--danger); color: white; }
        .bg-warning { background: var(--warning); color: white; }
        .bg-primary { background: var(--primary); color: white; }

        .badge { padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 700; }
        .badge-success { background: #dcfce7; color: #166534; }
        .badge-danger { background: #fee2e2; color: #991b1b; }

        .tab-content { display: none; } .tab-content.active { display: block; }
        .section-title { margin-top: 30px; color: var(--primary); font-size: 14px; text-transform: uppercase; letter-spacing: 1px; }
        
        /* Chat UI */
        .chat-container { height: 300px; overflow-y: auto; background: #f1f5f9; padding: 15px; border-radius: 10px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 8px; }
        .msg { padding: 8px 12px; border-radius: 10px; max-width: 70%; font-size: 12px; }
        .msg.admin { background: var(--primary); color: white; align-self: flex-end; }
        .msg.user { background: white; color: black; align-self: flex-start; border: 1px solid #ddd; }
    </style>
</head>
<body>

<div class="sidebar">
    <div style="padding: 25px; font-weight: 800; font-size: 18px; color: var(--primary);">H4X CONTROL</div>
    <div class="nav-item active" onclick="showTab(event, 'users')">üë• User & Rigging</div>
    <div class="nav-item" onclick="showTab(event, 'deposits')">üí∞ Deposits</div>
    <div class="nav-item" onclick="showTab(event, 'withdrawals')">üèß Withdrawals</div>
    <div class="nav-item" onclick="showTab(event, 'recharge')">üì± SIM Recharge</div>
    <div class="nav-item" onclick="showTab(event, 'refer')">üéÅ Refer Rewards</div>
    <div class="nav-item" onclick="showTab(event, 'chat')">üí¨ Live Chat</div>
</div>

<div class="main">
    <div id="users" class="tab-content active">
        <div class="card">
            <h3>User Management & Balance Editor</h3>
            <table>
                <thead><tr><th>User</th><th>Wallet / Vault</th><th>Rigging</th><th>Status</th><th>Edit</th></tr></thead>
                <tbody id="userList"></tbody>
            </table>
        </div>
    </div>

    <div id="deposits" class="tab-content">
        <div class="card">
            <h3>üí∞ Pending Deposits</h3>
            <table>
                <thead><tr><th>Email</th><th>Amount</th><th>UTR</th><th>Action</th></tr></thead>
                <tbody id="depositPending"></tbody>
            </table>
            <h4 class="section-title">Last Transactions</h4>
            <table id="depositHistory"></table>
        </div>
    </div>

    <div id="withdrawals" class="tab-content">
        <div class="card">
            <h3>üèß Pending Withdrawals</h3>
            <table>
                <thead><tr><th>Email</th><th>Amount</th><th>UPI/Bank</th><th>Action</th></tr></thead>
                <tbody id="withdrawPending"></tbody>
            </table>
            <h4 class="section-title">Last Transactions</h4>
            <table id="withdrawHistory"></table>
        </div>
    </div>

    <div id="recharge" class="tab-content">
        <div class="card">
            <h3>üì± SIM Recharge Requests</h3>
            <table>
                <thead><tr><th>Mobile</th><th>Operator</th><th>Plan</th><th>Email</th><th>Action</th></tr></thead>
                <tbody id="rechargeList"></tbody>
            </table>
        </div>
    </div>

    <div id="chat" class="tab-content">
        <div class="card">
            <h3>üí¨ Live Chat Support</h3>
            <select id="chatTarget" style="width:100%; padding:10px; margin-bottom:10px; border-radius:8px;"></select>
            <div class="chat-container" id="chatBox"></div>
            <div style="display:flex; gap:10px;">
                <input type="text" id="chatInput" style="flex:1; padding:10px; border-radius:8px; border:1px solid #ddd;" placeholder="Type message...">
                <button class="btn-action bg-primary" onclick="sendAdminMsg()">Send</button>
            </div>
        </div>
    </div>

    <div id="refer" class="tab-content">
        <div class="card">
            <h3>üéÅ Refer Reward Claims</h3>
            <table>
                <thead><tr><th>User</th><th>Reward Amount</th><th>Action</th></tr></thead>
                <tbody id="referList"></tbody>
            </table>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, update, set, push, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = { apiKey: "AIzaSyAzfvbiqRqsQwBOOIkegxJD09di-S_tfHg", authDomain: "test-eb5e7.firebaseapp.com", databaseURL: "https://test-eb5e7-default-rtdb.firebaseio.com", projectId: "test-eb5e7", appId: "1:366282855653:web:dca7e000f5a22fb11f300c" };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- USER & BALANCE EDITOR ---
    onValue(ref(db, 'users'), snap => {
        let h = "", rH = "", chatTargets = "<option value=''>Select User to Chat</option>";
        snap.forEach(c => {
            const u = c.val();
            h += `<tr>
                <td>${u.email}</td>
                <td>W: ‚Çπ${u.balance || 0}<br><small>V: ‚Çπ${u.vault_balance || 0}</small></td>
                <td>
                    <button class="btn-action" style="background:${u.forceWin?'#10b981':'#ddd'}" onclick="rig('${c.key}','w')">W</button>
                    <button class="btn-action" style="background:${u.forceLoss?'#ef4444':'#ddd'}" onclick="rig('${c.key}','l')">L</button>
                </td>
                <td><button class="btn-action bg-danger" onclick="ban('${c.key}',${u.isBanned})">${u.isBanned?'UNBAN':'BAN'}</button></td>
                <td><button class="btn-action bg-warning" onclick="editBalance('${c.key}')">‚úé Edit</button></td>
            </tr>`;
            if(u.referBalance > 0) rH += `<tr><td>${u.email}</td><td>‚Çπ${u.referBalance}</td><td><button class="btn-action bg-warning" onclick="approveRefer('${c.key}',${u.referBalance})">Approve</button></td></tr>`;
            chatTargets += `<option value="${c.key}">${u.email}</option>`;
        });
        document.getElementById('userList').innerHTML = h;
        document.getElementById('referList').innerHTML = rH || "No refer claims";
        document.getElementById('chatTarget').innerHTML = chatTargets;
    });

    // --- DEPOSITS & WITHDRAWALS FIX ---
    onValue(ref(db, 'transactions'), snap => {
        let depP = "", witP = "", depH = "<thead><tr><th>Email</th><th>Amt</th><th>Status</th></tr></thead>", witH = "<thead><tr><th>Email</th><th>Amt</th><th>Status</th></tr></thead>";
        snap.forEach(c => {
            const t = c.val();
            const row = `<td>${t.email}</td><td>‚Çπ${t.amount}</td>`;
            if(t.status === 'Pending') {
                if(t.type === 'Deposit') depP += `<tr>${row}<td>${t.utr || 'N/A'}</td><td><button class="btn-action bg-success" onclick="approveFinance('${c.key}','${t.uid}',${t.amount},'Deposit')">‚úî</button> <button class="btn-action bg-danger" onclick="updateStatus('transactions','${c.key}','Rejected')">‚úñ</button></td></tr>`;
                else witP += `<tr>${row}<td><small>${t.upiId || t.bankDetails || 'N/A'}</small></td><td><button class="btn-action bg-success" onclick="updateStatus('transactions','${c.key}','Approved')">Paid</button> <button class="btn-action bg-danger" onclick="updateStatus('transactions','${c.key}','Rejected')">‚úñ</button></td></tr>`;
            } else {
                const badge = `<span class="badge ${t.status==='Approved'?'badge-success':'badge-danger'}">${t.status}</span>`;
                if(t.type === 'Deposit') depH += `<tr>${row}<td>${badge}</td></tr>`;
                else witH += `<tr>${row}<td>${badge}</td></tr>`;
            }
        });
        document.getElementById('depositPending').innerHTML = depP || "No pending deposits";
        document.getElementById('withdrawPending').innerHTML = witP || "No pending withdrawals";
        document.getElementById('depositHistory').innerHTML = depH;
        document.getElementById('withdrawHistory').innerHTML = witH;
    });

    // --- LIVE CHAT LOGIC ---
    window.sendAdminMsg = () => {
        const uid = document.getElementById('chatTarget').value;
        const msg = document.getElementById('chatInput').value;
        if(!uid || !msg) return;
        push(ref(db, `chats/${uid}`), { text: msg, sender: 'admin', time: Date.now() });
        document.getElementById('chatInput').value = "";
    };

    document.getElementById('chatTarget').onchange = (e) => {
        const uid = e.target.value;
        if(!uid) return;
        onValue(ref(db, `chats/${uid}`), snap => {
            let h = "";
            snap.forEach(c => {
                const m = c.val();
                h += `<div class="msg ${m.sender}">${m.text}</div>`;
            });
            const box = document.getElementById('chatBox');
            box.innerHTML = h;
            box.scrollTop = box.scrollHeight;
        });
    };

    // --- RECHARGE LOGIC ---
    onValue(ref(db, 'recharge_requests'), snap => {
        let h = "";
        snap.forEach(c => {
            const r = c.val();
            if(r.status === 'Pending') {
                h += `<tr><td>${r.mobile}</td><td>${r.operator}</td><td>‚Çπ${r.amount}</td><td>${r.userEmail}</td>
                <td><button class="btn-action bg-success" onclick="updateStatus('recharge_requests','${c.key}','Paid')">‚úî</button>
                <button class="btn-action bg-danger" onclick="updateStatus('recharge_requests','${c.key}','Rejected')">‚úñ</button></td></tr>`;
            }
        });
        document.getElementById('rechargeList').innerHTML = h || "No requests";
    });

    // --- ACTIONS ---
    window.approveFinance = async (tid, uid, amt, type) => {
        if(type === 'Deposit') await update(ref(db, `users/${uid}`), { balance: increment(Number(amt)) });
        update(ref(db, `transactions/${tid}`), { status: 'Approved' });
        alert("Deposit Approved & Balance Updated!");
    };
    
    window.editBalance = (uid) => {
        const newBal = prompt("Enter New Wallet Balance:");
        if(newBal !== null) update(ref(db, `users/${uid}`), { balance: Number(newBal) });
    };

    window.rig = (id, type) => update(ref(db, `users/${id}`), { forceWin: type==='w', forceLoss: type==='l' });
    window.ban = (id, s) => update(ref(db, `users/${id}`), { isBanned: !s });
    window.updateStatus = (path, id, status) => update(ref(db, `${path}/${id}`), { status: status });
    window.showTab = (e, id) => {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(id).classList.add('active'); e.currentTarget.classList.add('active');
    };
</script>
</body>
</html>
