<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Control | H4XTEAM</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4361ee;
            --success: #06d6a0;
            --danger: #ff4d4d;
            --bg: #f4f7fe;
            --white: #ffffff;
            --text-dark: #1e293b;
            --text-light: #64748b;
        }

        body { background-color: var(--bg); color: var(--text-dark); font-family: 'Plus Jakarta Sans', sans-serif; margin: 0; padding: 20px; }
        .container { max-width: 1100px; margin: auto; }
        
        /* Stats & Header */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--white); padding: 20px; border-radius: 18px; box-shadow: 0 5px 15px rgba(0,0,0,0.02); border: 1px solid #edf2f7; }
        .stat-card h3 { font-size: 12px; color: var(--text-light); text-transform: uppercase; margin: 0 0 10px 0; }
        .stat-card div { font-size: 24px; font-weight: 800; color: var(--primary); }

        /* Sections */
        .section { background: var(--white); padding: 25px; border-radius: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.04); margin-bottom: 30px; border: 1px solid rgba(0,0,0,0.02); }
        .section-title { font-size: 16px; font-weight: 800; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }

        /* Tables */
        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 15px; background: #f8fafc; font-size: 11px; color: var(--text-light); border-bottom: 2px solid #f1f5f9; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; font-size: 13px; font-weight: 600; }

        /* Controls */
        input, select { padding: 10px; border-radius: 10px; border: 1px solid #e2e8f0; font-family: inherit; font-size: 13px; }
        button { padding: 10px 18px; border-radius: 10px; font-weight: 700; cursor: pointer; border: none; transition: 0.2s; font-size: 11px; }
        .btn-blue { background: var(--primary); color: white; }
        .btn-green { background: var(--success); color: white; }
        .btn-red { background: var(--danger); color: white; }
        
        /* Login Overlay */
        #loginOverlay { position: fixed; inset: 0; background: var(--primary); display: flex; justify-content: center; align-items: center; z-index: 10000; }
        .login-card { background: white; padding: 40px; border-radius: 30px; text-align: center; width: 320px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }

        /* Tabs */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { background: #e2e8f0; color: #64748b; padding: 12px 25px; border-radius: 12px; cursor: pointer; font-weight: 700; }
        .tab-btn.active { background: var(--primary); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .badge { padding: 4px 8px; border-radius: 6px; font-size: 10px; text-transform: uppercase; }
        .bg-pending { background: #fff7ed; color: #c2410c; }
        .bg-success { background: #ecfdf5; color: #065f46; }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-card">
        <div style="font-size: 40px; margin-bottom: 15px;">üóùÔ∏è</div>
        <h2>Admin Access</h2>
        <input type="password" id="adminPass" placeholder="Enter System Key" style="text-align: center; margin-bottom: 20px; width: 100%;">
        <button class="btn-blue" style="width: 100%;" onclick="checkAuth()">Unlock Dashboard</button>
    </div>
</div>

<div class="container">
    <div class="stats-grid">
        <div class="stat-card"><h3>Total Float</h3><div id="floatVal">‚Çπ0</div></div>
        <div class="stat-card"><h3>Pending Recharge</h3><div id="pendRec">0</div></div>
        <div class="stat-card"><h3>Active Users</h3><div id="userCount">0</div></div>
    </div>

    <div class="tabs">
        <div class="tab-btn active" onclick="showTab('users')">Users & Config</div>
        <div class="tab-btn" onclick="showTab('recharges')">Recharge Req</div>
        <div class="tab-btn" onclick="showTab('withdrawals')">Withdraw/Deposit</div>
        <div class="tab-btn" onclick="showTab('history')">History Log</div>
    </div>

    <div id="users" class="tab-content active">
        <div class="section">
            <div class="section-title">‚öôÔ∏è Payment & Plan Config</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <input type="text" id="upiId" placeholder="Admin UPI ID">
                <button class="btn-blue" onclick="saveData('settings/payment', {upi: document.getElementById('upiId').value})">Update UPI</button>
            </div>
            <div style="margin-top:20px; display:flex; gap:10px;">
                <input type="number" id="p1" placeholder="Plan 1 Price" style="width:100px">
                <input type="number" id="p2" placeholder="Plan 2 Price" style="width:100px">
                <input type="number" id="p3" placeholder="Plan 3 Price" style="width:100px">
                <button class="btn-blue" onclick="savePlans()">Set All Plan Prices</button>
            </div>
        </div>

        <div class="section">
            <div class="section-title">üë• User Management</div>
            <div class="table-wrap">
                <table>
                    <thead><tr><th>User</th><th>Balance</th><th>Status</th><th>Action</th></tr></thead>
                    <tbody id="userList"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="recharges" class="tab-content">
        <div class="section">
            <div class="section-title">üì± Mobile Recharge Requests</div>
            <div class="table-wrap">
                <table>
                    <thead><tr><th>Number</th><th>SIM</th><th>Amount</th><th>Action</th></tr></thead>
                    <tbody id="rechargeList"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="withdrawals" class="tab-content">
        <div class="grid" style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
            <div class="section">
                <div class="section-title">üì• Deposits</div>
                <tbody id="depositList"></tbody>
                <table id="depTable"></table>
            </div>
            <div class="section">
                <div class="section-title">üì§ Withdrawals</div>
                <table id="withTable"></table>
            </div>
        </div>
    </div>

    <div id="history" class="tab-content">
        <div class="section">
            <div class="section-title">üìú Action History</div>
            <div class="table-wrap">
                <table>
                    <thead><tr><th>Type</th><th>Detail</th><th>Amount</th><th>Status</th><th>Time</th></tr></thead>
                    <tbody id="historyList"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, update, set, increment, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

   const firebaseConfig = {
  apiKey: "AIzaSyAzfvbiqRqsQwBOOIkegxJD09di-S_tfHg",
  authDomain: "test-eb5e7.firebaseapp.com",
  databaseURL: "https://test-eb5e7-default-rtdb.firebaseio.com",
  projectId: "test-eb5e7",
  storageBucket: "test-eb5e7.appspot.com",
  messagingSenderId: "366282855653",
  appId: "1:366282855653:web:dca7e000f5a22fb11f300c",
  measurementId: "G-ECKCTBLQJ8"
};

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    window.checkAuth = function() {
        if(document.getElementById("adminPass").value === "admin123") {
            document.getElementById("loginOverlay").style.display = "none";
            initAdmin();
        } else { alert("Wrong Password"); }
    }

    window.showTab = (id) => {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.target.classList.add('active');
    }

    function initAdmin() {
        // Load Users
        onValue(ref(db, "users/"), snap => {
            let html = ""; let float = 0; let count = 0;
            snap.forEach(child => {
                const u = child.val();
                float += (u.balance || 0); count++;
                html += `<tr>
                    <td>${u.email ? u.email.split('@')[0] : 'User'}</td>
                    <td>‚Çπ${u.balance || 0} <button onclick="editBal('${child.key}')">‚úèÔ∏è</button></td>
                    <td><span class="badge ${u.status === 'banned' ? 'btn-red' : 'bg-success'}">${u.status || 'active'}</span></td>
                    <td><button class="btn-red" onclick="banUser('${child.key}')">BAN</button></td>
                </tr>`;
            });
            document.getElementById("userList").innerHTML = html;
            document.getElementById("floatVal").innerText = "‚Çπ" + float.toLocaleString();
            document.getElementById("userCount").innerText = count;
        });

        // Load Recharge Requests
        onValue(ref(db, "recharge_requests"), snap => {
            let html = ""; let pCount = 0;
            let histHtml = "";
            snap.forEach(child => {
                const r = child.val();
                if(r.status === "Pending") {
                    pCount++;
                    html += `<tr>
                        <td>${r.mobile}</td>
                        <td>${r.operator}</td>
                        <td>‚Çπ${r.amount}</td>
                        <td>
                            <button class="btn-green" onclick="handleRecharge('${child.key}', '${r.uid}', 'Success', '${r.mobile}')">Approve</button>
                            <button class="btn-red" onclick="handleRecharge('${child.key}', '${r.uid}', 'Rejected', '${r.mobile}')">Reject</button>
                        </td>
                    </tr>`;
                } else {
                    histHtml = `<tr><td>Recharge</td><td>${r.mobile}</td><td>‚Çπ${r.amount}</td><td>${r.status}</td><td>${r.timestamp}</td></tr>` + histHtml;
                }
            });
            document.getElementById("rechargeList").innerHTML = html || "<tr><td colspan='4'>No Pending Requests</td></tr>";
            document.getElementById("pendRec").innerText = pCount;
            document.getElementById("historyList").innerHTML = histHtml;
        });
    }

    // Process Recharge & Notify
    window.handleRecharge = async (id, uid, status, mobile) => {
        await update(ref(db, `recharge_requests/${id}`), { status: status });
        
        // Notification logic
        const notifyRef = ref(db, `users/${uid}/notifications`);
        await set(notifyRef, {
            title: status === "Success" ? "‚úÖ Recharge Successful" : "‚ùå Recharge Rejected",
            message: status === "Success" 
                ? `Your recharge for ${mobile} was successful! Balance updated.` 
                : `Recharge for ${mobile} failed. Contact Support.`,
            time: new Date().toLocaleString()
        });
        alert("Action Completed & User Notified");
    };

    window.savePlans = async () => {
        const plans = {
            Airtel: [{p: document.getElementById('p1').value}, {p: document.getElementById('p2').value}, {p: document.getElementById('p3').value}],
            Jio: [{p: document.getElementById('p1').value}, {p: document.getElementById('p2').value}, {p: document.getElementById('p3').value}]
        };
        await set(ref(db, "settings/plans"), plans);
        alert("Plans updated for all users!");
    };

    window.editBal = async (uid) => {
        const newBal = prompt("Enter new balance amount:");
        if(newBal) await update(ref(db, `users/${uid}`), { balance: Number(newBal) });
    };

    window.saveData = async (path, data) => {
        await update(ref(db, path), data);
        alert("Config Updated!");
    };
</script>
</body>
</html>
