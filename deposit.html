<!DOCTYPE html>
<html>
<head>
<title>Deposit</title>
<link rel="stylesheet" href="assets/css/neon.css">
</head>

<body>

<div class="nav">
    <a href="dashboard.html">Home</a>
    <a href="deposit.html">Deposit</a>
    <a href="withdraw.html">Withdraw</a>
    <a href="profile.html">Profile</a>
    <a href="settings.html">Settings</a>
</div>

<h1>Deposit</h1>

<div class="card">
    <input id="amount" type="number" placeholder="Enter amount (50-500)">
    <button onclick="makeDeposit()">Generate QR</button>
</div>

<div class="card" id="qrBox" style="display:none;">
    <h2>Scan to Pay</h2>
    <img id="qr" width="220">
    <p id="finalAmount"></p>
</div>

<script type="module">
import { auth, db, generateUPI, generateApiID } from "./assets/js/firebase.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
import { ref, set, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

onAuthStateChanged(auth,(u)=>{
    if(!u) location.href="index.html";
});

window.makeDeposit = async function() {
    const amt = Number(amount.value);
    if (amt < 50 || amt > 500) { alert("Enter 50 to 500"); return; }

    const upi = generateUPI(amt);
    const id = generateApiID();

    qr.src = "https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=" + encodeURIComponent(upi);
    qrBox.style.display = "block";
    finalAmount.innerHTML = "You will pay: " + (amt*1.10).toFixed(2);

    await set(ref(db, "deposits/"+id), {
        uid: auth.currentUser.uid,
        amount: amt,
        feeAmount: (amt*1.10),
        qrData: upi,
        status: "PENDING"
    });

    const uref = ref(db, "users/" + auth.currentUser.uid);
    update(uref, {
        depositCount: (auth.currentUser.depositCount||0) + 1
    });
};
</script>

</body>
</html>
