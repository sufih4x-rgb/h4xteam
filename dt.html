<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dragon Tiger Ultimate Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --dragon: #1d4ed8; --tiger: #b45309; --tie: #059669; --bg: #000; --gold: #fbbf24; --surface: #111; }
        body { margin: 0; background: var(--bg); color: white; font-family: 'Inter', sans-serif; display: flex; justify-content: center; overflow-x: hidden; }
        .game-shell { width: 100%; max-width: 450px; min-height: 100vh; background: radial-gradient(circle at top, #2d0a0a, #000); position: relative; border: 4px solid #422006; display: flex; flex-direction: column; }

        /* Timer & Mode */
        .top-info { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: rgba(0,0,0,0.85); border-bottom: 1px solid var(--gold); }
        .mode-btn { background: #222; border: 1px solid var(--gold); color: var(--gold); padding: 5px 10px; border-radius: 5px; font-size: 11px; font-weight: 800; cursor: pointer; }
        .mode-btn.active { background: var(--gold); color: #000; }
        .timer-txt { color: var(--gold); font-weight: 900; font-size: 14px; }

        /* History Dots */
        .history-strip { display: flex; gap: 6px; padding: 10px; overflow-x: auto; background: rgba(255,255,255,0.05); border-bottom: 1px solid #222; }
        .dot { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 900; flex-shrink: 0; }
        .dot-dragon { background: var(--dragon); } .dot-tiger { background: var(--tiger); } .dot-tie { background: var(--tie); }

        /* Card Arena - FIXED REVEAL */
        .card-arena { height: 160px; display: flex; justify-content: center; align-items: center; gap: 20px; }
        .card { width: 65px; height: 90px; background: #333; border-radius: 8px; border: 2px solid var(--gold); display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: 900; color: transparent; transition: 0.6s; position: relative; }
        .card.reveal { background: white !important; color: black !important; transform: rotateY(360deg); }

        /* Betting Grid */
        .bet-grid { display: flex; height: 140px; padding: 10px; gap: 8px; }
        .zone { flex: 1; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: 900; cursor: pointer; border: 2px solid rgba(255,255,255,0.1); position: relative; transition: 0.2s; }
        .z-dragon { background: linear-gradient(145deg, #1e40af, #1e3a8a); }
        .z-tiger { background: linear-gradient(145deg, #92400e, #78350f); }
        .z-tie { flex: 0.6; background: linear-gradient(145deg, #065f46, #064e3b); font-size: 11px; }
        .active-bet { border-color: #fff; box-shadow: 0 0 15px white; }
        .chip-badge { position: absolute; top: -8px; background: var(--gold); color: #000; padding: 2px 6px; border-radius: 8px; font-size: 10px; font-weight: 800; display: none; }
        .overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.8); border-radius: 12px; display: none; align-items: center; justify-content: center; color: #ef4444; font-size: 12px; z-index: 5; font-weight: bold; }

        /* Transactions Section */
        .tx-section { flex-grow: 1; background: #0a0a0a; padding: 15px; border-top: 1px solid #333; overflow-y: auto; max-height: 200px; }
        .tx-row { display: flex; justify-content: space-between; font-size: 12px; padding: 8px 0; border-bottom: 1px solid #1a1a1a; }
        .tx-win { color: #10b981; } .tx-lose { color: #ef4444; }

        /* Bottom Panel */
        .controls { background: var(--surface); padding: 15px; border-top: 2px solid #333; }
        .chip-rack { display: flex; justify-content: center; gap: 10px; margin-bottom: 10px; }
        .chip { width: 42px; height: 42px; border-radius: 50%; border: 2px dashed #fff; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 900; cursor: pointer; }
        .chip.selected { border-color: var(--gold); border-style: solid; transform: scale(1.1); background: rgba(251, 191, 36, 0.2); }
    </style>
</head>
<body>

<div class="game-shell">
    <div class="top-info">
        <div style="display:flex; gap:5px;">
            <button class="mode-btn active" id="btn30" onclick="switchMode(30)">30s</button>
            <button class="mode-btn" id="btn60" onclick="switchMode(60)">1m</button>
        </div>
        <div class="timer-txt" id="timer-display">SYNCING...</div>
    </div>

    <div class="history-strip" id="history-box"></div>

    <div class="card-arena">
        <div id="c-dragon" class="card">?</div>
        <div style="font-weight:900; color:var(--gold)">VS</div>
        <div id="c-tiger" class="card">?</div>
    </div>

    <div class="bet-grid">
        <div class="zone z-dragon" onclick="handleBet('dragon')">
            <div class="overlay" id="ov-dragon">LOCKED</div>
            <div id="badge-dragon" class="chip-badge">0</div>
            DRAGON
        </div>
        <div class="zone z-tie" onclick="handleBet('tie')">
            <div class="overlay" id="ov-tie">LOCKED</div>
            <div id="badge-tie" class="chip-badge">0</div>
            TIE
        </div>
        <div class="zone z-tiger" onclick="handleBet('tiger')">
            <div class="overlay" id="ov-tiger">LOCKED</div>
            <div id="badge-tiger" class="chip-badge">0</div>
            TIGER
        </div>
    </div>

    <div class="tx-section">
        <div style="font-size: 10px; color: #666; margin-bottom: 8px;">MY TRANSACTIONS</div>
        <div id="tx-list"></div>
    </div>

    <div class="controls">
        <div class="chip-rack">
            <div class="chip selected" onclick="selectChip(10, this)" style="background:#1d4ed8">10</div>
            <div class="chip" onclick="selectChip(50, this)" style="background:#059669">50</div>
            <div class="chip" onclick="selectChip(100, this)" style="background:#dc2626">100</div>
        </div>
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <div style="font-weight:900; color:var(--gold);">₹<span id="bal-txt">0.00</span></div>
            <div style="font-size:11px;">BET: <span id="total-bet">₹0</span></div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, onValue, update, increment, get, push, query, limitToLast } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAzfvbiqRqsQwBOOIkegxJD09di-S_tfHg",
        authDomain: "test-eb5e7.firebaseapp.com",
        databaseURL: "https://test-eb5e7-default-rtdb.firebaseio.com",
        projectId: "test-eb5e7",
        appId: "1:366282855653:web:dca7e000f5a22fb11f300c"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let uBal = 0, currentChip = 10, mySide = null, myBet = 0, bettingOpen = false, currentMode = 30;
    const cards = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];

    window.switchMode = (m) => {
        if(myBet > 0) return alert("Current match active!");
        currentMode = m;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`btn${m}`).classList.add('active');
        loadHistory();
    };

    function syncEngine() {
        const now = new Date();
        const sec = now.getSeconds();
        if (currentMode === 60) {
            if (sec < 35) setBetState(true, `BETTING: ${35-sec}s`, "var(--gold)");
            else if (sec < 42) { if(bettingOpen) processResult(); setBetState(false, "REVEALING", "white"); }
            else { setBetState(false, `WAITING: ${60-sec}s`, "#666"); if(sec === 59) resetBoard(); }
        } else {
            const sub = sec % 30;
            if (sub < 15) setBetState(true, `FAST: ${15-sub}s`, "var(--gold)");
            else if (sub < 20) { if(bettingOpen) processResult(); setBetState(false, "REVEALING", "white"); }
            else { setBetState(false, `NEXT: ${30-sub}s`, "#666"); if(sub === 29) resetBoard(); }
        }
    }
    setInterval(syncEngine, 1000);

    function setBetState(open, txt, color) {
        bettingOpen = open;
        const d = document.getElementById("timer-display");
        d.innerText = txt; d.style.color = color;
        document.querySelectorAll(".overlay").forEach(o => o.style.display = open ? "none" : "flex");
    }

    onAuthStateChanged(auth, user => {
        if(!user) return;
        onValue(ref(db, `users/${user.uid}`), s => {
            uBal = s.val()?.balance || 0;
            document.getElementById("bal-txt").innerText = uBal.toFixed(2);
        });
        loadHistory();
        loadUserTransactions(user.uid);
    });

    window.handleBet = async (side) => {
        if(!bettingOpen) return;
        if(uBal < currentChip) return alert("Low Balance!");
        mySide = side; myBet += currentChip;
        document.getElementById(`badge-${side}`).innerText = "₹"+myBet;
        document.getElementById(`badge-${side}`).style.display = "block";
        document.getElementById("total-bet").innerText = "₹"+myBet;
        await update(ref(db, `users/${auth.currentUser.uid}`), { balance: increment(-currentChip) });
    };

    async function processResult() {
        bettingOpen = false;
        const uSnap = await get(ref(db, `users/${auth.currentUser.uid}`));
        const uData = uSnap.val() || {};
        let risk = uBal < 100 ? 0.4 : 0.85;
        let res = uData.forceWin ? (mySide || 'dragon') : (uData.forceLoss ? (mySide === 'dragon' ? 'tiger' : 'dragon') : (Math.random() < (1-risk) ? (mySide || 'dragon') : (mySide === 'dragon' ? 'tiger' : 'dragon')));

        // --- FIXED CARD REVEAL LOGIC ---
        const dCardVal = res === 'dragon' ? cards[12] : (res === 'tie' ? cards[5] : cards[1]);
        const tCardVal = res === 'tiger' ? cards[12] : (res === 'tie' ? cards[5] : cards[1]);

        const cardD = document.getElementById("c-dragon");
        const cardT = document.getElementById("c-tiger");

        cardD.innerText = dCardVal;
        cardD.classList.add("reveal");
        
        setTimeout(() => {
            cardT.innerText = tCardVal;
            cardT.classList.add("reveal");
            
            if(res === mySide) {
                let winAmt = myBet * (res === 'tie' ? 8 : 1.92);
                update(ref(db, `users/${auth.currentUser.uid}`), { balance: increment(winAmt) });
                saveTx(auth.currentUser.uid, 'WIN', winAmt);
            } else if(myBet > 0) {
                saveTx(auth.currentUser.uid, 'LOSE', myBet);
            }
            push(ref(db, `history_dt_${currentMode}`), { res, ts: Date.now() });
        }, 800);
    }

    async function saveTx(uid, type, amt) {
        await push(ref(db, `transactions/${uid}`), { type, amount: amt.toFixed(2), time: new Date().toLocaleTimeString('en-GB') });
    }

    function loadUserTransactions(uid) {
        onValue(query(ref(db, `transactions/${uid}`), limitToLast(8)), s => {
            const list = document.getElementById("tx-list"); list.innerHTML = "";
            s.forEach(snap => {
                const d = snap.val();
                list.innerHTML = `<div class="tx-row"><span>${d.time}</span><span class="${d.type=='WIN'?'tx-win':'tx-lose'}">${d.type=='WIN'?'+':'-'}₹${d.amount}</span></div>` + list.innerHTML;
            });
        });
    }

    function loadHistory() {
        onValue(query(ref(db, `history_dt_${currentMode}`), limitToLast(15)), s => {
            const box = document.getElementById("history-box"); box.innerHTML = "";
            s.forEach(snap => {
                const d = snap.val();
                box.innerHTML = `<div class="dot dot-${d.res}">${d.res[0].toUpperCase()}</div>` + box.innerHTML;
            });
        });
    }

    function resetBoard() {
        myBet = 0; mySide = null;
        document.getElementById("total-bet").innerText = "₹0";
        document.querySelectorAll(".chip-badge").forEach(b => b.style.display = "none");
        document.querySelectorAll(".card").forEach(c => { c.classList.remove("reveal"); c.innerText = "?"; });
    }

    window.selectChip = (v, el) => {
        currentChip = v;
        document.querySelectorAll('.chip').forEach(c => c.classList.remove('selected'));
        el.classList.add('selected');
    };
</script>
</body>
</html>
