<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard</title>
    <style>
        body { font-family: Arial; padding: 40px; max-width: 600px; margin: auto; }
        button { padding: 10px 20px; cursor: pointer; }
        #status { margin-top: 20px; padding: 10px; background: #f3f3f3; }
    </style>
</head>
<body>

<h1>Welcome to Your Dashboard</h1>
<p>You are logged in on this device.</p>

<button onclick="logout()">Logout</button>

<div id="status"></div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import {
  getAuth,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

import {
  getFirestore,
  doc,
  onSnapshot,
  deleteDoc
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyAzfvbiqRqsQwBOOIkegxJD09di-S_tfHg",
    authDomain: "test-eb5e7.firebaseapp.com",
    databaseURL: "https://test-eb5e7-default-rtdb.firebaseio.com",
    projectId: "test-eb5e7",
    storageBucket: "test-eb5e7.appspot.com",
    messagingSenderId: "366282855653",
    appId: "1:366282855653:web:dca7e000f5a22fb11f300c",
    measurementId: "G-ECKCTBLQJ8"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

// -------------------------------------------------------------
// Redirect if not logged in
// -------------------------------------------------------------
onAuthStateChanged(auth, (user) => {
    if (!user) {
        window.location.href = "index.html";
    } else {
        startDeviceWatcher(user);
    }
});

// -------------------------------------------------------------
// Logout
// -------------------------------------------------------------
window.logout = async function() {
    const user = auth.currentUser;
    if (user) {
        await deleteDoc(doc(db, "activeDevices", user.uid));
    }
    await signOut(auth);
    localStorage.removeItem("device_id");
    window.location.href = "index.html";
};

// -------------------------------------------------------------
// AUTO-LOGOUT when another device logs in
// -------------------------------------------------------------
function startDeviceWatcher(user) {

    const deviceID = localStorage.getItem("device_id");

    const ref = doc(db, "activeDevices", user.uid);

    onSnapshot(ref, async (snap) => {
        if (!snap.exists()) return;

        const saved = snap.data().deviceID;

        if (saved !== deviceID) {
            status.innerHTML = "You have been logged out because another device logged in.";

            await signOut(auth);
            localStorage.removeItem("device_id");

            setTimeout(() => {
                window.location.href = "index.html";
            }, 2000);
        }
    });
}

</script>
</body>
</html>
