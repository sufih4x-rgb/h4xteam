<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, onValue, push, set, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
  apiKey: "AIzaSyAzfvbiqRqsQwBOOIkegxJD09di-S_tfHg",
  authDomain: "test-eb5e7.firebaseapp.com",
  databaseURL: "https://test-eb5e7-default-rtdb.firebaseio.com",
  projectId: "test-eb5e7",
  storageBucket: "test-eb5e7.appspot.com",
  messagingSenderId: "366282855653",
  appId: "1:366282855653:web:dca7e000f5a22fb11f300c",
  measurementId: "G-ECKCTBLQJ8"
};

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let selectedSim = "";
    let adminPlans = {};

    onValue(ref(db, 'settings/plans'), (snap) => {
        if (snap.exists()) adminPlans = snap.val();
    });

    onAuthStateChanged(auth, (user) => {
        if(user) {
            onValue(ref(db, `users/${user.uid}/notifications`), (snap) => {
                if(snap.exists()) {
                    const d = snap.val();
                    const pop = document.getElementById('notifyPopup');
                    document.getElementById('notifTitle').innerText = d.title;
                    document.getElementById('notifMsg').innerText = d.message;
                    pop.style.display = 'block';
                    setTimeout(() => pop.style.display = 'none', 8000);
                }
            });
        }
    });

    window.selectSim = (sim, el) => {
        selectedSim = sim;
        document.querySelectorAll('.sim-card').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('phoneGroup').style.display = 'block';
        document.getElementById('pFill').style.width = '66%';
    };

    window.showPlans = () => {
        const num = document.getElementById('mobileNum').value;
        if (num.length === 10) {
            document.getElementById('pFill').style.width = '100%';
            const list = document.getElementById('plansList');
            list.innerHTML = "";
            
            const plans = adminPlans[selectedSim] || [{p:299},{p:479},{p:719}];
            const details = ["1.5GB/Day • 28 Days", "1.5GB/Day • 56 Days", "2GB/Day • 84 Days"];

            plans.forEach((p, i) => {
                const card = document.createElement('div');
                card.className = "plan-card";
                card.innerHTML = `
                    <div class="plan-info">
                        <div class="plan-price">₹${p.p}</div>
                        <div class="plan-details">${details[i]}</div>
                    </div>
                    <button class="select-btn" onclick="submitReq(${p.p})">SELECT</button>
                `;
                list.appendChild(card);
            });
            document.getElementById('plansArea').style.display = 'block';
        }
    };

    window.submitReq = async (amount) => {
        const num = document.getElementById('mobileNum').value;
        const user = auth.currentUser;
        if (!user) return alert("Please Login First");

        // --- NEW BALANCE CHECK LOGIC ---
        const userRef = ref(db, `users/${user.uid}`);
        const snapshot = await get(userRef);
        
        if (snapshot.exists()) {
            const userData = snapshot.val();
            const currentBalance = userData.balance || 0;

            if (currentBalance < amount) {
                alert(`Insufficient Balance! You need ₹${amount}, but you only have ₹${currentBalance}. Please deposit money first.`);
                window.location.href = "deposit.html"; // Redirect to deposit page
                return;
            }

            // If balance is enough, proceed with request
            const reqRef = ref(db, 'recharge_requests');
            await push(reqRef, {
                uid: user.uid,
                email: user.email,
                mobile: num,
                operator: selectedSim,
                amount: amount,
                status: "Pending",
                timestamp: new Date().toLocaleString()
            });

            document.getElementById('finalNum').innerText = "+91 " + num;
            document.getElementById('successScreen').style.display = 'flex';
        } else {
            alert("User data not found. Please contact support.");
        }
    };
</script>
