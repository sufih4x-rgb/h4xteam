<script type="module">
  // Firebase imports
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import { 
      getAuth, 
      createUserWithEmailAndPassword, 
      signInWithEmailAndPassword,
      sendEmailVerification,
      signOut
  } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

  import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      deleteDoc
  } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

  // ----------------------------
  // YOUR FIREBASE CONFIG
  // ----------------------------
  const firebaseConfig = {
      apiKey: "AIzaSyAzfvbiqRqsQwBOOIkegxJD09di-S_tfHg",
      authDomain: "test-eb5e7.firebaseapp.com",
      databaseURL: "https://test-eb5e7-default-rtdb.firebaseio.com",
      projectId: "test-eb5e7",
      storageBucket: "test-eb5e7.appspot.com",
      messagingSenderId: "366282855653",
      appId: "1:366282855653:web:dca7e000f5a22fb11f300c",
      measurementId: "G-ECKCTBLQJ8"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  // ----------------------------
  // DEVICE ID
  // ----------------------------
  function getDeviceID() {
      let dev = localStorage.getItem("device_id");
      if (!dev) {
          dev = crypto.randomUUID();
          localStorage.setItem("device_id", dev);
      }
      return dev;
  }

  // ----------------------------
  // REGISTER (unchanged)
  // ----------------------------
  window.register = function() {
      const email = document.getElementById("reg_email").value;
      const pass  = document.getElementById("reg_pass").value;

      createUserWithEmailAndPassword(auth, email, pass)
      .then((userCredential) => {
          sendEmailVerification(userCredential.user);
          document.getElementById("status").innerHTML =
              "Registered! Verification email sent.";
      })
      .catch((error) => {
          document.getElementById("status").innerHTML = error.message;
      });
  }

  // ----------------------------
  // SECURE ONE-DEVICE LOGIN
  // ----------------------------
  window.login = function() {
      const email = document.getElementById("log_email").value;
      const pass  = document.getElementById("log_pass").value;

      signInWithEmailAndPassword(auth, email, pass)
      .then(async (userCredential) => {
          const user = userCredential.user;

          // --- Check email verified ---
          if (!user.emailVerified) {
              document.getElementById("status").innerHTML =
                  "Please verify your email before logging in.";
              await signOut(auth);
              return;
          }

          // ----- Secure Device Enforcement -----
          const deviceID = getDeviceID();
          const userRef  = doc(db, "activeDevices", user.uid);
          const snap     = await getDoc(userRef);

          if (!snap.exists()) {
              // No device linked yet â€” claim this device
              await setDoc(userRef, { deviceID });
              document.getElementById("status").innerHTML =
                  "Login successful!";
          } 
          else {
              const saved = snap.data().deviceID;

              if (saved !== deviceID) {
                  // Another device already logged in
                  document.getElementById("status").innerHTML =
                      "This account is already logged in on another device.";
                  await signOut(auth);
                  return;
              }

              // Same device allowed
              document.getElementById("status").innerHTML =
                  "Login successful!";
          }
      })
      .catch((error) => {
          document.getElementById("status").innerHTML = error.message;
      });
  }

  // ----------------------------
  // LOGOUT (recommended)
  // ----------------------------
  window.logout = async function() {
      const user = auth.currentUser;
      if (user) {
          await deleteDoc(doc(db, "activeDevices", user.uid));
      }
      await signOut(auth);
      localStorage.removeItem("device_id");
      document.getElementById("status").innerHTML = "Logged out.";
  }
</script>
