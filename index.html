<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Login / Register</title>

<style>
    body {
        margin: 0;
        background: #000;
        font-family: Arial;
        color: #fff;
        display: flex;
        height: 100vh;
        justify-content: center;
        align-items: center;
    }
    .card {
        width: 380px;
        padding: 30px;
        background: rgba(0, 0, 0, 0.5);
        border: 1px solid #0ff;
        box-shadow: 0 0 20px #0ff;
        border-radius: 10px;
    }
    input {
        width: 100%;
        padding: 12px;
        margin: 8px 0;
        border-radius: 6px;
        border: 1px solid #0ff;
        background: #000;
        color: #0ff;
        box-shadow: 0 0 10px #0ff inset;
    }
    button {
        width: 100%;
        padding: 12px;
        background: #0ff;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        cursor: pointer;
        margin-top: 10px;
        color: #000;
        font-weight: bold;
        box-shadow: 0 0 20px #0ff;
    }
    button:hover {
        background: #00cccc;
        box-shadow: 0 0 30px #0ff;
    }
    .link {
        color: #0ff;
        display: block;
        margin-top: 10px;
        text-align: center;
        cursor: pointer;
    }
    #status {
        color: #0ff;
        text-align: center;
        margin-top: 12px;
    }
</style>
</head>
<body>

<div class="card">
    <h2 style="text-align:center;">Neon Login</h2>

    <input id="email" type="email" placeholder="Email">
    <input id="pass" type="password" placeholder="Password">

    <button onclick="login()">Login</button>
    <button onclick="register()">Register</button>

    <a class="link" href="reset.html">Forgot Password?</a>

    <div id="status"></div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { 
    getAuth, 
    createUserWithEmailAndPassword, 
    sendEmailVerification,
    signInWithEmailAndPassword,
    sendPasswordResetEmail,
    signOut
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

import {
    getDatabase,
    ref,
    set,
    get
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAzfvbiqRqsQwBOOIkegxJD09di-S_tfHg",
  authDomain: "test-eb5e7.firebaseapp.com",
  databaseURL: "https://test-eb5e7-default-rtdb.firebaseio.com",
  projectId: "test-eb5e7",
  storageBucket: "test-eb5e7.appspot.com",
  messagingSenderId: "366282855653",
  appId: "1:366282855653:web:dca7e000f5a22fb11f300c",
  measurementId: "G-ECKCTBLQJ8"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getDatabase();

// Device ID

function getDeviceID() {
    let id = localStorage.getItem("deviceID");
    if (!id) {
        id = crypto.randomUUID();
        localStorage.setItem("deviceID", id);
    }
    return id;
}

// REGISTER

window.register = function() {
    const email = document.getElementById("email").value;
    const pass  = document.getElementById("pass").value;

    createUserWithEmailAndPassword(auth, email, pass)
    .then(async (u) => {
        await sendEmailVerification(u.user);
        status.innerHTML = "Verification link sent to your email.";
    })
    .catch(e => status.innerHTML = e.message);
};

// LOGIN

window.login = async function() {
    const email = document.getElementById("email").value;
    const pass  = document.getElementById("pass").value;

    signInWithEmailAndPassword(auth, email, pass)
    .then(async (cred) => {
        const user = cred.user;

        if (!user.emailVerified) {
            status.innerHTML = "Please verify your email.";
            await signOut(auth);
            return;
        }

        // One-device login check
        const deviceID = getDeviceID();
        const userRef = ref(db, "activeDevices/" + user.uid);

        const snap = await get(userRef);
        if (snap.exists()) {
            if (snap.val().deviceID !== deviceID) {
                status.innerHTML = "Account already logged in on another device.";
                await signOut(auth);
                return;
            }
        }

        await set(userRef, { deviceID });

        status.innerHTML = "Login successful!";
        setTimeout(() => window.location.href = "dashboard.html", 800);
    })
    .catch(() => status.innerHTML = "Login failed.");
};

</script>
</body>
</html>
